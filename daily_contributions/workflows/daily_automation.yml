name: Daily Commit Automation

on:
  schedule:
    # Run at 9:00, 14:00, and 16:00 UTC on weekdays (Monday-Friday)
    - cron: '0 9,14,16 * * 1-5'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run automation even if not scheduled time'
        required: false
        default: 'false'
        type: boolean
      dry_run:
        description: 'Run in dry-run mode (no actual commits)'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.9'
  AUTOMATION_PATH: 'code/automation-hub/daily_contributions'

jobs:
  daily-commit-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Quality Tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy pylint
        
    - name: Install Node.js Dependencies (if needed)
      if: hashFiles('package.json') != ''
      run: |
        npm install -g prettier eslint
        
    - name: Install Go Dependencies (if needed)
      if: hashFiles('go.mod') != ''
      run: |
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        
    - name: Install Rust Dependencies (if needed)
      if: hashFiles('Cargo.toml') != ''
      run: |
        rustup component add rustfmt
        
    - name: Run Repository Health Check
      id: health-check
      run: |
        cd ${{ env.AUTOMATION_PATH }}
        python main_coordinator.py --config config/automation_config.json --dry-run
        echo "health_status=$?" >> $GITHUB_OUTPUT
        
    - name: Run Code Quality Checks
      id: quality-check
      run: |
        cd ${{ env.AUTOMATION_PATH }}
        python -c "
        from scripts.code_quality_tool import CodeQualityTool
        tool = CodeQualityTool()
        tasks = tool.get_improvement_tasks()
        print(f'Found {len(tasks)} code quality improvement opportunities')
        "
        
    - name: Run Documentation Analysis
      id: doc-check
      run: |
        cd ${{ env.AUTOMATION_PATH }}
        python -c "
        from scripts.doc_automation import DocumentationAutomator
        automator = DocumentationAutomator()
        tasks = automator.get_documentation_tasks()
        print(f'Found {len(tasks)} documentation improvement opportunities')
        "
        
    - name: Check Dependency Status
      id: deps-check
      run: |
        cd ${{ env.AUTOMATION_PATH }}
        python -c "
        from scripts.dependency_updater import DependencyUpdater
        updater = DependencyUpdater()
        tasks = updater.get_pending_updates()
        print(f'Found {len(tasks)} dependency update opportunities')
        "
        
    - name: Run Daily Automation (Conditional)
      id: automation
      if: |
        (github.event_name == 'schedule') || 
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.force_run == 'true' || ${{ env.FORCE_RUN }}))
      env:
        DRY_RUN: ${{ github.event.inputs.dry_run == 'true' }}
      run: |
        cd ${{ env.AUTOMATION_PATH }}
        
        if [ "$DRY_RUN" = "true" ]; then
          echo "Running in dry-run mode..."
          python main_coordinator.py --config config/automation_config.json --interactive
        else
          echo "Running automation..."
          python main_coordinator.py --config config/automation_config.json
        fi
        
    - name: Check for Changes
      id: check-changes
      run: |
        if git diff --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected:"
          git status --porcelain
        fi
        
    - name: Create Pull Request (if changes)
      if: steps.check-changes.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Automated daily improvements'
        title: 'Daily Automation - Repository Improvements'
        body: |
          ## ðŸ¤– Automated Daily Improvements
            
          This PR contains automated improvements made during the daily commit automation cycle.
          
          ### ðŸ“‹ Improvements Made
          - Repository health checks
          - Code quality enhancements
          - Documentation updates
          - Dependency updates (if applicable)
          - Configuration optimizations
          
          ### ðŸ“Š Automation Summary
          - **Execution Time**: ${{ github.event.head_commit.timestamp }}
          - **Branch**: ${{ github.ref_name }}
          - **Commit Count**: $(git rev-list --count HEAD)
          
          ### ðŸ” What Changed
          $(git diff --stat)
          
          ### âœ… Quality Checks
          - All automated tests passed
          - Code quality tools ran successfully
          - Documentation standards maintained
          
          > This PR was created automatically by the Daily Commit Automation system.
          > 
          > Please review the changes and merge if everything looks good!
        branch: automation/daily-improvements
        delete-branch: true
        
    - name: Commit Changes Directly (if no PR workflow)
      if: |
        steps.check-changes.outputs.has_changes == 'true' && 
        github.event.inputs.dry_run != 'true' &&
        contains(github.event.pull_request.head.ref, 'automation/') == false
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git commit -am "Automated daily improvements

        - Enhanced repository health
        - Improved code quality
        - Updated documentation
        - Applied automation best practices"
        
        git push
        
    - name: Upload Automation Logs
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: automation-logs-${{ github.run_number }}
        path: |
          ${{ env.AUTOMATION_PATH }}/daily_contributions.log
          ${{ env.AUTOMATION_PATH }}/.commit_history.json
          ${{ env.AUTOMATION_PATH }}/config/automation_config.json
        retention-days: 7
        
    - name: Generate Automation Report
      if: always()
      run: |
        cd ${{ env.AUTOMATION_PATH }}
        
        echo "## ðŸ“Š Daily Automation Report" > automation_report.md
        echo "" >> automation_report.md
        echo "**Date**: $(date)" >> automation_report.md
        echo "**Run ID**: ${{ github.run_id }}" >> automation_report.md
        echo "**Status**: ${{ job.status }}" >> automation_report.md
        echo "" >> automation_report.md
        
        if [ -f daily_contributions.log ]; then
          echo "### ðŸ“‹ Recent Log Entries" >> automation_report.md
          echo "\`\`\`" >> automation_report.md
          tail -n 20 daily_contributions.log >> automation_report.md
          echo "\`\`\`" >> automation_report.md
        fi
        
        # Generate summary statistics
        if [ -f .commit_history.json ]; then
          echo "### ðŸ“ˆ Commit Statistics" >> automation_report.md
          python -c "
          import json
          try:
              with open('.commit_history.json', 'r') as f:
                  history = json.load(f)
              print(f'- Total commits: {len(history)}')
              if history:
                  print(f'- Last commit: {history[-1]['timestamp']}')
          except:
              print('- No commit history available')
          " >> automation_report.md
        fi
        
        echo "" >> automation_report.md
        echo "---" >> automation_report.md
        echo "*Generated by Daily Commit Automation*" >> automation_report.md
        
    - name: Upload Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: automation-report-${{ github.run_number }}
        path: ${{ env.AUTOMATION_PATH }}/automation_report.md
        retention-days: 30

  # Optional: Notify team about automation results
  notification:
    if: always() && (github.event_name == 'schedule' || github.event.inputs.force_run == 'true')
    needs: daily-commit-automation
    runs-on: ubuntu-latest
    
    steps:
    - name: Send Notification
      run: |
        echo "Daily automation completed with status: ${{ needs.daily-commit-automation.result }}"
        
        # You can add notifications here:
        # - Slack webhook
        # - Email
        # - Discord webhook
        # - Teams webhook
        
        # Example Slack notification:
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"Daily automation completed: ${{ needs.daily-commit-automation.result }}"}' \
        #   ${{ secrets.SLACK_WEBHOOK }}

  # Cleanup job to remove old artifacts
  cleanup:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Cleanup Old Artifacts
      uses: actions/github-script@v6
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId,
          });
          
          const oldArtifacts = artifacts.data.artifacts.filter(artifact => {
            const created = new Date(artifact.created_at);
            const daysDiff = (Date.now() - created.getTime()) / (1000 * 60 * 60 * 24);
            return daysDiff > 7;
          });
          
          for (const artifact of oldArtifacts) {
            await github.rest.actions.deleteArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifact.id,
            });
          }