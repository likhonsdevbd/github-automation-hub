name: Documentation Automation

on:
  schedule:
    # Run daily at 10:00 PM UTC (after main development hours)
    - cron: '0 22 * * *'
  workflow_dispatch:
    inputs:
      docs_type:
        description: 'Type of documentation to generate'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - api
          - readme
          - changelog
          - examples

permissions:
  contents: write
  issues: read

jobs:
  documentation-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Get full history for documentation
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install mkdocs mkdocs-material mkdocstrings[python] mike
        
    - name: API Documentation Generation
      run: |
        echo "Generating API documentation..."
        python -m daily_contributions.scripts.doc_automation --generate-api-docs
        
    - name: README Enhancement
      run: |
        echo "Enhancing README documentation..."
        python -c "
        from daily_contributions.scripts.doc_automation import DocumentationAutomation
        
        doc_auto = DocumentationAutomation()
        doc_auto.enhance_readme()
        print('README enhanced successfully')
        "
        
    - name: CHANGELOG Generation
      run: |
        echo "Generating automated CHANGELOG..."
        python -c "
        from datetime import datetime, timedelta
        import subprocess
        import json
        
        # Get recent commits (last 7 days)
        since_date = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
        
        # Generate changelog
        try:
            result = subprocess.run([
                'git', 'log', '--since', since_date, 
                '--pretty=format:%s|%b|%an|%ad', 
                '--date=short'
            ], capture_output=True, text=True)
            
            commits = []
            for line in result.stdout.split('\n'):
                if line and not line.startswith('Merge'):
                    parts = line.split('|')
                    if len(parts) >= 3:
                        commits.append({
                            'title': parts[0].strip(),
                            'body': parts[1].strip() if len(parts) > 1 else '',
                            'author': parts[2].strip() if len(parts) > 2 else 'Unknown',
                        })
            
            # Generate changelog
            changelog = f'''# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased] - {datetime.now().strftime('%Y-%m-%d')}

### Added
'''
            
            # Categorize commits
            for commit in commits:
                title = commit['title']
                if any(keyword in title.lower() for keyword in ['add', 'feature', 'implement']):
                    changelog += f'- {title} ({commit[\"author\"]})\n'
                elif any(keyword in title.lower() for keyword in ['fix', 'bug', 'patch']):
                    changelog += f'- {title} ({commit[\"author\"]})\n'
                elif any(keyword in title.lower() for keyword in ['update', 'improve', 'enhance']):
                    changelog += f'- {title} ({commit[\"author\"]})\n'
            
            changelog += '''
### Changed
### Deprecated
### Removed
### Fixed
### Security
'''
            
            with open('CHANGELOG.md', 'w') as f:
                f.write(changelog)
                
            print('CHANGELOG.md generated successfully')
            
        except Exception as e:
            print(f'Error generating changelog: {e}')
        "
        
    - name: Code Examples Documentation
      run: |
        echo "Generating code examples documentation..."
        python -c "
        import os
        import glob
        
        # Find Python files and generate examples
        examples_content = '''# Code Examples

This document contains practical examples of using the GitHub Automation Hub.

## Quick Start

```python
from scripts.automation_manager import AutomationManager

# Initialize automation manager
manager = AutomationManager()

# Run daily health check
health_score = manager.run_health_check()
print(f'Repository health: {health_score}/100')
```

## Growth Analytics

```python
from growth_analysis.main import create_growth_engine

# Create growth analysis engine
engine = create_growth_engine()

# Analyze repository growth
analysis = engine.run_complete_analysis('your-repo')
print(f'Growth patterns: {len(analysis[\"growth_patterns\"])}')
```

## Community Analytics

```python
from community_analytics.analytics_orchestrator import CommunityAnalyticsOrchestrator

# Initialize community analytics
ca = CommunityAnalyticsOrchestrator()

# Get community health metrics
health = ca.analyze_community_health()
print(f'Community grade: {health[\"grade\"]}')
```
'''
        
        os.makedirs('docs/examples', exist_ok=True)
        with open('docs/examples/quick-start.md', 'w') as f:
            f.write(examples_content)
            
        print('Code examples generated successfully')
        "
        
    - name: Architecture Documentation
      run: |
        echo "Updating architecture documentation..."
        python -c "
        import os
        
        # Generate architecture diagram description
        architecture_doc = '''# System Architecture

## Overview

The GitHub Automation Hub is designed with a modular architecture:

```
┌─────────────────────────────────────────────────┐
│                 GitHub API                      │
└─────────────────┬───────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────┐
│            Automation Hub                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │  Analytics  │ │  Health     │ │   Growth    │ │
│  │  Orchestrator│ │ Monitoring  │ │  Analysis   │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │   Security  │ │ Community   │ │   Daily     │ │
│  │ Automation  │ │ Analytics   │ │Contributions│ │
│  └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────┬───────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────┐
│            External Systems                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │  Monitoring │ │    APIs     │ │   Storage   │ │
│  │ (Prometheus)│ │  (External) │ │ (Local/DB)  │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────┘
```

## Core Components

### 1. Analytics Orchestrator
- Coordinates data processing across modules
- Manages API rate limiting and caching
- Provides unified data access layer

### 2. Health Monitoring
- Real-time repository health scoring
- Community engagement tracking
- Performance monitoring

### 3. Growth Analysis
- Predictive modeling for growth
- Anomaly detection
- Competitive benchmarking

### 4. Security Automation
- Vulnerability scanning
- Dependency monitoring
- Security reporting

### 5. Community Analytics
- Contributor lifecycle tracking
- Engagement scoring
- Network analysis

### 6. Daily Contributions
- Automated documentation updates
- Code quality improvements
- Repository health enhancements

## Data Flow

1. **Collection**: GitHub API data collection with rate limiting
2. **Processing**: Analytics and health score calculations
3. **Storage**: Time-series and relational data storage
4. **Analysis**: Growth predictions and anomaly detection
5. **Output**: Reports, dashboards, and automated actions

## Safety Features

- Conservative rate limiting (max 8 actions/hour for automation)
- Platform compliance verification
- Human-in-the-loop controls
- Comprehensive audit logging
- Emergency stop capabilities

## Deployment

The system uses GitHub Actions for:
- Automated daily operations
- Security scanning
- Health monitoring
- Growth analytics
- Documentation generation
'''
        
        os.makedirs('docs/architecture', exist_ok=True)
        with open('docs/architecture/overview.md', 'w') as f:
            f.write(architecture_doc)
            
        print('Architecture documentation updated successfully')
        "
        
    - name: Check Documentation Links
      run: |
        echo "Validating documentation links..."
        python -c "
        import glob
        import re
        import os
        
        # Find all markdown files
        md_files = glob.glob('**/*.md', recursive=True)
        
        broken_links = []
        
        for file_path in md_files:
            try:
                with open(file_path, 'r') as f:
                    content = f.read()
                    
                # Find markdown links
                links = re.findall(r'\[([^\]]+)\]\(([^)]+)\)', content)
                
                for link_text, link_url in links:
                    # Skip external links
                    if link_url.startswith('http') or link_url.startswith('mailto'):
                        continue
                    
                    # Check if local file exists
                    if not os.path.exists(link_url):
                        broken_links.append(f'{file_path}: {link_text} -> {link_url}')
                        
            except Exception as e:
                print(f'Error checking {file_path}: {e}')
        
        if broken_links:
            print('\\n⚠️  Broken links found:')
            for link in broken_links:
                print(f'  - {link}')
        else:
            print('✅ All documentation links are valid')
        "
        
    - name: Commit Documentation Updates
      if: ${{ !github.event.workflow_dispatch }}
      run: |
        git config --local user.email "automation@github.com"
        git config --local user.name "GitHub Automation Bot"
        
        # Check if there are changes to commit
        git status
        git add README.md CHANGELOG.md docs/ || true
        
        # Commit only if there are actual changes
        if ! git diff --staged --quiet; then
          git commit -m "docs: Auto-update documentation - $(date)"
          git push
          echo "✅ Documentation updated and committed"
        else
          echo "ℹ️  No documentation changes to commit"
        fi
        
    - name: Upload Documentation
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: documentation-updates
        path: |
          README.md
          CHANGELOG.md
          docs/
        retention-days: 90