name: Daily Automation Hub

on:
  schedule:
    # Run at 9:00, 14:00, and 16:00 UTC daily (conservative schedule)
    - cron: '0 9 * * *'
    - cron: '0 14 * * *'
    - cron: '0 16 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual changes)'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write
  discussions: write

env:
  PYTHON_VERSION: '3.9'
  CONSERVATIVE_MODE: 'true'
  MAX_DAILY_ACTIONS: '24'
  HUMAN_LIKE_DELAYS: 'true'

jobs:
  daily-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Safety Configuration Check
      run: |
        echo "Running safety checks..."
        python -m scripts.cli safety --verify-config
        
    - name: Repository Health Check
      run: |
        echo "Checking repository health..."
        python -m daily_contributions.main_coordinator --health-check
        
    - name: Automated Documentation Updates
      if: ${{ !inputs.dry_run || inputs.dry_run == 'true' }}
      run: |
        echo "Updating documentation..."
        python -m daily_contributions.scripts.doc_automation --enhance-readme
        
    - name: Dependency Updates
      if: ${{ !inputs.dry_run || inputs.dry_run == 'true' }}
      run: |
        echo "Checking for dependency updates..."
        python -m daily_contributions.scripts.dependency_updater --safe-update
        
    - name: Code Quality Improvements
      if: ${{ !inputs.dry_run || inputs.dry_run == 'true' }}
      run: |
        echo "Applying code quality improvements..."
        python -m daily_contributions.scripts.code_quality_tool --auto-fix
        
    - name: Generate Daily Report
      run: |
        echo "Generating daily automation report..."
        python -m scripts.cli report --daily --save
        
    - name: Upload Daily Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: daily-automation-report
        path: |
          daily_report_*.json
          automation.log
        retention-days: 30
        
    - name: Rate Limit Check
      run: |
        echo "Checking API rate limits..."
        python -m scripts.cli rate-limit --status